# Free Trial System - Architecture Diagram

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FRONTEND (React Native)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ProfileScreen   â”‚  â”‚  AnalyzeScreen   â”‚  â”‚ FreeTrialEnded   â”‚     â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚     Modal        â”‚     â”‚
â”‚  â”‚  â€¢ Shows trial   â”‚  â”‚  â€¢ Upload photo  â”‚  â”‚                  â”‚     â”‚
â”‚  â”‚    status        â”‚  â”‚  â€¢ Trigger       â”‚  â”‚  â€¢ Upgrade CTA   â”‚     â”‚
â”‚  â”‚  â€¢ Remaining     â”‚  â”‚    analysis      â”‚  â”‚  â€¢ Benefits      â”‚     â”‚
â”‚  â”‚    count         â”‚  â”‚  â€¢ Show modal    â”‚  â”‚  â€¢ Dismiss       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                     â”‚                      â”‚                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                 â”‚                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚   useAPIAnalysis Hook   â”‚                         â”‚
â”‚                    â”‚                         â”‚                         â”‚
â”‚                    â”‚  â€¢ Manages analysis     â”‚                         â”‚
â”‚                    â”‚  â€¢ Checks permissions   â”‚                         â”‚
â”‚                    â”‚  â€¢ Handles errors       â”‚                         â”‚
â”‚                    â”‚  â€¢ Shows modal          â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                 â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  subscriptionService.ts  â”‚
                    â”‚                          â”‚
                    â”‚  â€¢ canUserAnalyze()      â”‚
                    â”‚  â€¢ getFreeTrialStatus()  â”‚
                    â”‚  â€¢ incrementUsageCounter â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SUPABASE BACKEND                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Database Functions                             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  can_user_analyze_with_trial()                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check active subscription                                     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ If yes: Use subscription analyses                          â”‚  â”‚
â”‚  â”‚  â””â”€ If no: Check free trial                                       â”‚  â”‚
â”‚  â”‚     â””â”€ Return: can_analyze, remaining, is_free_trial              â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  use_free_trial_analysis()                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check free trial remaining > 0                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ Decrement counter                                             â”‚  â”‚
â”‚  â”‚  â””â”€ Track usage in usage_tracking table                           â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  increment_usage_counter()                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check for active subscription                                 â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ If yes: Increment subscription counter                     â”‚  â”‚
â”‚  â”‚  â””â”€ If no: Call use_free_trial_analysis()                         â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      Database Tables                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  profiles                                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (UUID)                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ email                                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ free_trial_analyses_remaining (INTEGER, default: 2) â­       â”‚  â”‚
â”‚  â”‚  â””â”€ has_had_subscription (BOOLEAN, default: false) â­            â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  user_subscriptions                                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (UUID)                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ user_id (UUID)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ plan_id (UUID)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ subscription_status                                           â”‚  â”‚
â”‚  â”‚  â””â”€ analyses_used_this_month                                      â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  usage_tracking                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (UUID)                                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ user_id (UUID)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ subscription_id (UUID, nullable)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ analysis_type                                                 â”‚  â”‚
â”‚  â”‚  â””â”€ metadata (JSONB) â†’ { is_free_trial: true } â­               â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â­ = New/Modified for Free Trial System
```

## ğŸ”„ Data Flow Diagram

### Scenario 1: User with Free Trial Performs Analysis

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. Clicks "Analyze Muscles"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnalyzeScreen   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. Calls analyzeImage()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useAPIAnalysis Hook â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. Calls canUserAnalyze()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ subscriptionService.ts   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. RPC: can_user_analyze_with_trial()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Function                          â”‚
â”‚                                            â”‚
â”‚ 1. Check for active subscription           â”‚
â”‚    â””â”€ None found                           â”‚
â”‚                                            â”‚
â”‚ 2. Check free_trial_analyses_remaining     â”‚
â”‚    â””â”€ Found: 2                             â”‚
â”‚                                            â”‚
â”‚ 3. Return:                                 â”‚
â”‚    {                                       â”‚
â”‚      can_analyze: true,                    â”‚
â”‚      analyses_remaining: 2,                â”‚
â”‚      subscription_status: 'free_trial',    â”‚
â”‚      plan_name: 'Free Trial',              â”‚
â”‚      is_free_trial: true                   â”‚
â”‚    }                                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. Returns result
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ subscriptionService.ts   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. Returns to hook
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useAPIAnalysis Hook â”‚
â”‚                     â”‚
â”‚ âœ… can_analyze=true â”‚
â”‚ âœ… Proceed with     â”‚
â”‚    analysis         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 7. Perform analysis
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Analysis API â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 8. Returns results
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useAPIAnalysis Hook â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 9. Calls incrementUsageCounter()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ subscriptionService.ts   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 10. RPC: increment_usage_counter()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Function                          â”‚
â”‚                                            â”‚
â”‚ 1. Check for active subscription           â”‚
â”‚    â””â”€ None found                           â”‚
â”‚                                            â”‚
â”‚ 2. Call use_free_trial_analysis()          â”‚
â”‚    â”œâ”€ Decrement: 2 â†’ 1                     â”‚
â”‚    â””â”€ Track in usage_tracking              â”‚
â”‚                                            â”‚
â”‚ 3. Return:                                 â”‚
â”‚    {                                       â”‚
â”‚      success: true,                        â”‚
â”‚      analyses_remaining: 1,                â”‚
â”‚      is_free_trial: true                   â”‚
â”‚    }                                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 11. Returns result
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useAPIAnalysis Hook â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 12. Navigate to Results
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ResultsScreenâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 2: User Exhausts Free Trial

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚
â”‚          â”‚
â”‚ Trial: 0 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. Clicks "Analyze Muscles"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnalyzeScreen   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. Calls analyzeImage()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useAPIAnalysis Hook â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. Calls canUserAnalyze()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ subscriptionService.ts   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. RPC: can_user_analyze_with_trial()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Function                          â”‚
â”‚                                            â”‚
â”‚ 1. Check for active subscription           â”‚
â”‚    â””â”€ None found                           â”‚
â”‚                                            â”‚
â”‚ 2. Check free_trial_analyses_remaining     â”‚
â”‚    â””â”€ Found: 0                             â”‚
â”‚                                            â”‚
â”‚ 3. Return:                                 â”‚
â”‚    {                                       â”‚
â”‚      can_analyze: false,                   â”‚
â”‚      analyses_remaining: 0,                â”‚
â”‚      subscription_status: 'free_trial',    â”‚
â”‚      plan_name: 'Free Trial',              â”‚
â”‚      is_free_trial: true                   â”‚
â”‚    }                                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. Returns result
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ subscriptionService.ts   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. Returns to hook
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useAPIAnalysis Hook â”‚
â”‚                     â”‚
â”‚ âŒ can_analyze=falseâ”‚
â”‚ âŒ Error:           â”‚
â”‚    FREE_TRIAL_ENDED â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 7. Calls onError callback
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnalyzeScreen   â”‚
â”‚                 â”‚
â”‚ Sets:           â”‚
â”‚ showFreeTrialEndâ”‚
â”‚ edModal = true  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 8. Renders modal
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FreeTrialEndedModal  â”‚
â”‚                      â”‚
â”‚ ğŸ‰ Free Trial        â”‚
â”‚    Complete!         â”‚
â”‚                      â”‚
â”‚ [View Plans]         â”‚
â”‚ [Maybe Later]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—‚ï¸ File Structure

```
project-root/
â”‚
â”œâ”€â”€ Database/
â”‚   â”œâ”€â”€ add-free-trial-system.sql          # Migration script
â”‚   â””â”€â”€ deploy-free-trial.bat              # Deployment script
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ FreeTrialEndedModal.tsx        # Upgrade modal
â”‚   â”‚
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”œâ”€â”€ AnalyzeScreen.tsx              # Updated with modal
â”‚   â”‚   â””â”€â”€ ProfileScreen.tsx              # Shows trial status
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useAPIAnalysis.ts              # Analysis logic
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ subscriptionService.ts         # Free trial functions
â”‚   â”‚
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ subscription.ts                # Type definitions
â”‚
â””â”€â”€ Documentation/
    â”œâ”€â”€ FREE_TRIAL_README.md               # Main readme
    â”œâ”€â”€ FREE_TRIAL_QUICK_START.md          # Quick guide
    â”œâ”€â”€ FREE_TRIAL_SYSTEM.md               # Complete docs
    â”œâ”€â”€ FREE_TRIAL_IMPLEMENTATION_SUMMARY.md
    â”œâ”€â”€ FREE_TRIAL_USER_JOURNEY.md         # User flow
    â”œâ”€â”€ FREE_TRIAL_TESTING_CHECKLIST.md    # Testing guide
    â””â”€â”€ FREE_TRIAL_ARCHITECTURE.md         # This file
```

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layers                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Layer 1: Authentication                                    â”‚
â”‚  â”œâ”€ Supabase Auth                                           â”‚
â”‚  â”œâ”€ JWT tokens                                              â”‚
â”‚  â””â”€ Session management                                      â”‚
â”‚                                                             â”‚
â”‚  Layer 2: Authorization                                     â”‚
â”‚  â”œâ”€ Row Level Security (RLS)                                â”‚
â”‚  â”œâ”€ User can only access own data                           â”‚
â”‚  â””â”€ Functions use SECURITY DEFINER                          â”‚
â”‚                                                             â”‚
â”‚  Layer 3: Validation                                        â”‚
â”‚  â”œâ”€ Backend validation (can't be bypassed)                  â”‚
â”‚  â”œâ”€ Database constraints                                    â”‚
â”‚  â””â”€ Type checking                                           â”‚
â”‚                                                             â”‚
â”‚  Layer 4: Data Integrity                                    â”‚
â”‚  â”œâ”€ CHECK constraints on columns                            â”‚
â”‚  â”œâ”€ Foreign key relationships                               â”‚
â”‚  â””â”€ Transaction isolation                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Analytics Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Analytics Pipeline                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Event Tracking                                             â”‚
â”‚  â”œâ”€ Free trial start                                        â”‚
â”‚  â”œâ”€ Analysis completion                                     â”‚
â”‚  â”œâ”€ Free trial exhaustion                                   â”‚
â”‚  â”œâ”€ Modal view                                              â”‚
â”‚  â”œâ”€ CTA click                                               â”‚
â”‚  â””â”€ Conversion                                              â”‚
â”‚                                                             â”‚
â”‚  Data Storage                                               â”‚
â”‚  â”œâ”€ usage_tracking table                                    â”‚
â”‚  â”‚  â””â”€ metadata: { is_free_trial: true }                    â”‚
â”‚  â”œâ”€ profiles table                                          â”‚
â”‚  â”‚  â””â”€ free_trial_analyses_remaining                        â”‚
â”‚  â””â”€ user_subscriptions table                                â”‚
â”‚     â””â”€ has_had_subscription                                 â”‚
â”‚                                                             â”‚
â”‚  Metrics Calculation                                        â”‚
â”‚  â”œâ”€ Conversion rate                                         â”‚
â”‚  â”œâ”€ Trial completion rate                                   â”‚
â”‚  â”œâ”€ Time between analyses                                   â”‚
â”‚  â””â”€ Drop-off points                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    State Flow                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Global State (Context)                                     â”‚
â”‚  â”œâ”€ AuthContext                                             â”‚
â”‚  â”‚  â””â”€ user, authProfile                                    â”‚
â”‚  â””â”€ SubscriptionContext                                     â”‚
â”‚     â””â”€ isSubscribed, activePlan                             â”‚
â”‚                                                             â”‚
â”‚  Component State                                            â”‚
â”‚  â”œâ”€ ProfileScreen                                           â”‚
â”‚  â”‚  â””â”€ freeTrialRemaining                                   â”‚
â”‚  â”œâ”€ AnalyzeScreen                                           â”‚
â”‚  â”‚  â””â”€ showFreeTrialEndedModal                              â”‚
â”‚  â””â”€ FreeTrialEndedModal                                     â”‚
â”‚     â””â”€ visible                                              â”‚
â”‚                                                             â”‚
â”‚  Hook State                                                 â”‚
â”‚  â””â”€ useAPIAnalysis                                          â”‚
â”‚     â”œâ”€ state (loading, error, progress)                     â”‚
â”‚     â””â”€ result                                               â”‚
â”‚                                                             â”‚
â”‚  Server State (Supabase)                                    â”‚
â”‚  â”œâ”€ profiles.free_trial_analyses_remaining                  â”‚
â”‚  â”œâ”€ user_subscriptions.subscription_status                  â”‚
â”‚  â””â”€ usage_tracking records                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Deployment Flow                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Step 1: Database Migration                                 â”‚
â”‚  â”œâ”€ Run deploy-free-trial.bat                               â”‚
â”‚  â”œâ”€ Execute add-free-trial-system.sql                       â”‚
â”‚  â”œâ”€ Add columns to profiles                                 â”‚
â”‚  â”œâ”€ Create database functions                               â”‚
â”‚  â””â”€ Update existing users                                   â”‚
â”‚                                                             â”‚
â”‚  Step 2: Backend Deployment                                 â”‚
â”‚  â”œâ”€ Update subscriptionService.ts                           â”‚
â”‚  â”œâ”€ Update types                                            â”‚
â”‚  â””â”€ Deploy to production                                    â”‚
â”‚                                                             â”‚
â”‚  Step 3: Frontend Deployment                                â”‚
â”‚  â”œâ”€ Add FreeTrialEndedModal component                       â”‚
â”‚  â”œâ”€ Update AnalyzeScreen                                    â”‚
â”‚  â”œâ”€ Update ProfileScreen                                    â”‚
â”‚  â””â”€ Deploy to app stores                                    â”‚
â”‚                                                             â”‚
â”‚  Step 4: Verification                                       â”‚
â”‚  â”œâ”€ Test with new user                                      â”‚
â”‚  â”œâ”€ Verify database changes                                 â”‚
â”‚  â”œâ”€ Check analytics tracking                                â”‚
â”‚  â””â”€ Monitor error rates                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Summary

This architecture provides:
- âœ… **Secure** - Backend validation, RLS policies
- âœ… **Scalable** - Optimized queries, proper indexing
- âœ… **Maintainable** - Clear separation of concerns
- âœ… **Testable** - Isolated components and functions
- âœ… **Observable** - Complete analytics tracking

The system is production-ready and follows best practices for security, performance, and user experience.
